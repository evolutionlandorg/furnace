#!/usr/bin/env bash

set -e

. $(PWD)/bin/init

path=$FNC_CONFIG

# back=0x0cdb9637a755e90861Be98d401953e28449D0983
address=$(dapp create src/LandResourceAuthorityV4.sol:LandResourceAuthorityV4 [$PETBASE_PROXY,$TOKENUSE_PROXY,$APOSTLEITEMBAR_PROXY,$LANDITEMBAR_PROXY])
export LANDRESOURCEAUTHORITY=$address

seth send -F $OWNER $LANDRESOURCE_PROXY "setAuthority(address)" $LANDRESOURCEAUTHORITY 
if test $(seth call $LANDRESOURCE_PROXY "authority()(address)") != $LANDRESOURCEAUTHORITY ; then
  (echo "migrate LANDRESOURCEAUTHORITY failed ${auth}"; exit 1;)
fi

allowlist=($PETBASE_PROXY $TOKENUSE_PROXY $APOSTLEITEMBAR_PROXY $LANDITEMBAR_PROXY)
for allow in "${allowlist[@]}"; do
  res=$(seth call $LANDRESOURCEAUTHORITY "whiteList(address)(bool)" $allow)
  if test "$res" != true; then
    (echo "migrate LANDRESOURCEAUTHORITY failed ${allow}"; exit 1;)
  fi
done
cat $path | jq '.LANDRESOURCEAUTHORITY = $address' --arg address $LANDRESOURCEAUTHORITY | sponge $path

echo >&2 "${0##*/}: info: setauthority finished."

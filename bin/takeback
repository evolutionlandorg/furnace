#!/usr/bin/env bash

set -ex

. $(PWD)/bin/init

# take back 
# _hashmessage = hash("${_user}${_nonce}${_expireTime}${networkId}${grade[]}")

n=$(seth call $DRILLTAKEBACK "userToNonce(address)(uint256)" $OWNER)
nonce=$(seth --to-uint256 $n)
d=$(($(date +%s) + 100))
expireTime=$(seth --to-uint256 $d)
networkId=$(seth --to-uint256 3)
grade1=$(seth --to-uint256 2)
grade2=$(seth --to-uint256 3)
msg="${OWNER}${nonce:2}${expireTime:2}${networkId:2}${grade1:2}${grade2:2}" 
# abi.encodePacked(_user, _nonce, _expireTime, networkId, _grades)
hashmsg=$(seth keccak $msg)
signedmsg=$(ethsign msg --from $SUPERVISOR --data $hashmsg --passphrase-file $ETH_PASSWORD --key-store $ETH_KEYSTORE)
prefixedHash=$(seth call $ECDSA "toEthSignedMessageHash(bytes32)" $hashmsg)
signer=$(seth call $ECDSA "recover(bytes32,bytes)" $prefixedHash $signedmsg)
dec=$(seth --abi-decode 'f()(address,bytes32,bytes32,uint8)' "$signer")
sup=$(echo $dec | cut -d' ' -f 1)
r=$(echo $dec | cut -d' ' -f 2)
s=$(echo $dec | cut -d' ' -f 3)
v=$(echo $dec | cut -d' ' -f 4)
seth send -F $OWNER $DRILLTAKEBACK "takeBack(uint256,uint256,uint16[],bytes32,uint8,bytes32,bytes32)" $nonce $expireTime [$grade1,$grade2] $hashmsg $v $r $s  

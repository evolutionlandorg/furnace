#!/usr/bin/env bash

set -e

if [ "$FNC_VERBOSE" ]; then set -x; fi

. $(PWD)/script/init

admin=$(dapp create src/FurnaceProxyAuth.sol:FurnaceProxyAuth)
echo >&2 "${0##*/}: info: FurnaceProxyAuth created."
itembase=$(dapp create src/ItemBase.sol:ItemBase)
echo >&2 "${0##*/}: info: ItemBase created."
calldata=$(seth calldata "initialize(address)" $ISETTINGSREGISTRY)
itemBaseProxy=$(dapp create src/ItemBaseProxy.sol:ItemBaseProxy $itembase $admin $calldata)
echo >&2 "${0##*/}: info: ItemBaseProxy inited."

# seth send $admin "upgrade(address,address)" $itemBaseProxy $itemBase
# seth send $admin "upgradeAndCall(address,address,bytes)" $itemBaseProxy $itembase $calldata 
# seth send $temBaseProxy "initialize(address)" $ISETTINGSREGISTRY

path=$FNC_CONFIG
cat $path | jq '.ITEMBASE = $address' --arg address $address | sponge $path

OWNERSHIPV3WHITELIST=[$LANDBASE_PROXY,$APOSTLEBASE_PROXY,$ERC721BRIDGE_PROXY,$itemBaseProxy]
ownerShipAuth=$(dapp create src/ObjectOwnershipAuthorityV3.sol:ObjectOwnershipAuthorityV3 $OWNERSHIPV3WHITELIST)
echo >&2 "${0##*/}: info: ObjectOwnershipAuthorityV3 created."
seth send -F $OWNER $IOBJECTOWNERSHIP_PROXY "setauthority(address)" $ownerShipAuth 
seth --abi-decode 'f()(address[])' $(seth call $IOBJECTOWNERSHIP_PROXY "authority()")
echo >&2 "${0##*/}: info: setauthority finished."
seth send -F $OWNER $INTERSTELLARENCODER "registerNewObjectClass(address,uint8)" $itemBaseProxy $(seth --to-hex 100) 
seth call $INTERSTELLARENCODER "classAddress2Id(address)" $itemBaseProxy 
seth call $INTERSTELLARENCODER "ownershipId2Address(uint8)" $(seth --to-hex 4) 
item=$(seth --to-bytes32 $(seth --to-hex $(seth --from-ascii "CONTRACT_ITEM_BASE")))
seth send -F $OWNER $ISETTINGSREGISTRY "setAddressProperty(bytes32,address)" $item $ITEMBASE_PROXY 
seth call $ISETTINGSREGISTRY "addressOf(bytes32)" $item  
echo >&2 "${0##*/}: info: installerEncoder register finished."

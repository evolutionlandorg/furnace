#!/usr/bin/env bash

set -e

. $(PWD)/bin/init

path=$FNC_CONFIG

address=$(dapp create src/ApostleItemBar.sol:ApostleItemBar)
export APOSTLEITEMBAR=$address
cat $path | jq '.APOSTLEITEMBAR = $address' --arg address $APOSTLEITEMBAR | sponge $path

echo >&2 "${0##*/}: info: ApostleItemBar created."

# 1
maxAmount=$(seth --to-uint256 3)
calldata=$(seth calldata "initialize(address,uint256)" $ISETTINGSREGISTRY $maxAmount)
apostlebarProxy=$(dapp create src/ApostleItemBarProxy.sol:ApostleItemBarProxy $APOSTLEITEMBAR $FURNACEPROXYADMIN $calldata)
export APOSTLEITEMBAR_PROXY=$apostlebarProxy
cat $path | jq '.APOSTLEITEMBAR_PROXY = $address' --arg address $APOSTLEITEMBAR_PROXY | sponge $path
echo >&2 "${0##*/}: info: ApostleItemBarProxy inited."

# setting registry
registry=$(seth --to-bytes32 $(seth --to-hex $(seth --from-ascii "CONTRACT_APOSTLE_ITEM_BAR")))
seth send -F $OWNER $ISETTINGSREGISTRY "setAddressProperty(bytes32,address)" $registry $APOSTLEITEMBAR_PROXY
if test $(seth call $ISETTINGSREGISTRY "addressOf(bytes32)(address)" $registry) != $APOSTLEITEMBAR_PROXY; then
  (echo "check register ${registry} failed."; exit 1;)
fi
echo >&2 "${0##*/}: info: installerEncoder register finished."

